variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://docker:2375/

services:
  - docker:dind

stages:
  - build

.build-arch-template: &build-template
  image: jonoh/docker-buildx-qemu
  before_script:
    - docker buildx create --driver docker-container --use
    - docker buildx inspect --bootstrap

    # https://askubuntu.com/a/1398147
    - docker pull tonistiigi/binfmt:latest
    - docker run --privileged --rm tonistiigi/binfmt --uninstall qemu-*
    - docker run --privileged --rm tonistiigi/binfmt --install all

    - update-binfmts --enable

  script:
    - ls
    - docker buildx build --platform linux/$CI_JOB_NAME
      -t genius -o type=docker,dest=- . > genius-img.tar
    - docker load < genius-img.tar
    - docker run --name c /bin/sh genius

    - docker cp c:/genius/target .
    - docker cp c:/usr/local/cargo .
    - docker rm -f c

  artifacts:
    paths:
      - genius-img.tar
      - target/release/genius

  cache:
    paths:
      - cargo
      - target

# this could be simplified
amd64:
  stage: build
  <<: *build-template

arm64:
  stage: build
  <<: *build-template
